{% extends 'base.html' %}
{% block content %}
<section class="content" style="background: linear-gradient(to right, #e6f7ef, #ffffff); min-height: 100vh; padding-top: 20px;">
  <div class="container-fluid">

    <div class="row">

      <!-- Upload / Camera Column -->
      <div class="col-md-6">
        <div class="card shadow-lg rounded" style="border-top: 4px solid #2f855a;">
          <div class="card-header text-center" style="background-color:#2f855a; color:white;">
            <h5 class="mb-0"><i class="fas fa-camera"></i> {{ t["detection"] }}</h5>
          </div>

          <form method="POST" enctype="multipart/form-data" id="detectionForm">
            <div class="card-body">

              <!-- CAMERA BUTTON CENTERED -->
              <div class="form-group mb-3 text-center">
                <label><strong style="color: #77967e;">{{ t["use_camera_for_detection"] }}</strong></label><br>
                <div class="d-flex justify-content-center">
                  <button type="button" class="btn" style="background-color:#2f855a; color:white;" id="openCameraBtn">
                    <i class="fas fa-camera"></i> {{ t["use_camera_for_detection"] }}
                  </button>
                </div>

                <video id="cameraPreview" autoplay playsinline 
                       style="display:none; width:100%; margin-top:10px; border-radius:10px; border:1px solid #ccc;"></video>

                <button type="button" class="btn mt-2" style="background-color:#2f855a; color:white;" id="capturePhotoBtn">
                  {{ t["capture_photo"] }}Capture
                </button>

                <canvas id="cameraCanvas" style="display:none;"></canvas>
              </div>

              <!-- FILE UPLOAD -->
              <div class="form-group mt-3">
                <label for="image" style="color: #28a745; font-weight:bold;">{{ t["select_image"] }}</label>
                <input type="file" name="image" accept="image/*" id="fileInput" class="form-control border-success">
              </div>

              <button type="submit" class="btn mt-3 w-100" style="background-color:#2f855a; color:white;">{{ t["detect"] }}</button>
            </div>
          </form>
        </div>

        <!-- RESULTS -->
        {% if result %}
        <div class="alert rounded shadow-sm mt-3" style="background-color:#28a745; color:white;">
          <strong>{{ t["result"] }}:</strong> {{ result }}<br>
          <strong>{{ t["confidence"] }}:</strong> {{ confidence }}
        </div>
        {% endif %}
      </div>

      <!-- Disease Info Column (Text Only) -->
      {% if disease %}
      <div class="col-md-6">
        <div class="card shadow-lg rounded">
          <div class="card-body" style="text-align: justify;">

            <h5 style="color:#28a745;"><strong>{{ disease.name }}</strong></h5>

            <!-- Description -->
            <p><strong>{{ t["description"] }}:</strong></p>
            <div style="margin-left: 10px; color:#212221;">
              {{ disease.description | replace('\n', '<br>') | safe }}
            </div>

            <!-- Symptoms -->
            <p class="mt-2"><strong>{{ t["symptoms"] }}:</strong></p>
            <div style="margin-left: 10px; color:#212221;">
              {{ disease.symptoms | replace('\n', '<br>') | safe }}
            </div>

            <!-- Treatment -->
            <p class="mt-2"><strong>{{ t["treatment"] }}:</strong></p>
            <div style="margin-left: 10px; color:#212221;">
              {{ disease.treatment | replace('\n', '<br>') | safe }}
            </div>

          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</section>

<!-- CAMERA JS -->
<script>
const openCameraBtn = document.getElementById('openCameraBtn');
const capturePhotoBtn = document.getElementById('capturePhotoBtn');
const video = document.getElementById('cameraPreview');
const canvas = document.getElementById('cameraCanvas');
let stream;

openCameraBtn.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.style.display = 'block';
        capturePhotoBtn.style.display = 'inline-block';
    } catch (err) {
        alert('Camera access denied or not available.');
        console.error(err);
    }
});

capturePhotoBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    stream.getTracks().forEach(track => track.stop());
    video.style.display = 'none';
    capturePhotoBtn.style.display = 'none';

    canvas.toBlob((blob) => {
        const file = new File([blob], `capture_${Date.now()}.png`, { type: 'image/png' });
        const data = new FormData();
        data.append('image', file);
        fetch("", { method: "POST", body: data })
          .then(res => res.text())
          .then(html => {
              document.open();
              document.write(html);
              document.close();
          });
    }, 'image/png');
});
</script>
{% endblock %}
